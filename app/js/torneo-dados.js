document.addEventListener('DOMContentLoaded', () => {
    // Modal de bienvenida para el torneo
    const welcomeModal = document.getElementById('welcome-modal-tournament');
    const startTournamentBtn = document.getElementById('start-tournament-btn');
    const closeBtn = welcomeModal.querySelector('.modal-close');

    // Mostrar el modal al cargar la pÃ¡gina
    welcomeModal.style.display = 'flex';
    welcomeModal.style.backgroundColor = 'rgba(0, 0, 0, 0)';
    const dialog = welcomeModal.querySelector('.modal-dialog');
    if (dialog) {
        dialog.style.transform = 'scale(0.7) translateY(-50px)';
        dialog.style.opacity = '0';
    }

    // AnimaciÃ³n suave de entrada
    setTimeout(() => {
        welcomeModal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        if (dialog) {
            dialog.style.transform = 'scale(1) translateY(0)';
            dialog.style.opacity = '1';
        }
    }, 10);

    function hideModal() {
        welcomeModal.classList.remove('show');
        const dialog = welcomeModal.querySelector('.modal-dialog');
        if (dialog) {
            dialog.style.transform = 'scale(0.7) translateY(50px)';
            dialog.style.opacity = '0';
        }
        setTimeout(() => {
            welcomeModal.style.display = 'none';
            welcomeModal.style.backgroundColor = 'rgba(0, 0, 0, 0)';
        }, 300);
    }

    if (startTournamentBtn) {
        startTournamentBtn.addEventListener('click', hideModal);
    }
    if (closeBtn) {
        closeBtn.addEventListener('click', hideModal);
    }

    // LÃ³gica del slider del torneo
    const slides = document.querySelectorAll('.slider-slide');
    const leftArrow = document.getElementById('slider-left');
    const rightArrow = document.getElementById('slider-right');
    const dots = document.querySelectorAll('.dot');
    let currentSlide = 0;

    function showSlide(index) {
        slides.forEach(slide => slide.classList.remove('active'));
        slides[index].classList.add('active');

        // Actualizar dots
        dots.forEach(dot => dot.classList.remove('active'));
        if (dots[index]) {
            dots[index].classList.add('active');
        }

        // Actualizar estado de las flechas
        leftArrow.disabled = index === 0;
        rightArrow.disabled = index === slides.length - 1;

        // Controlar animaciÃ³n de pulso en la flecha derecha
        if (index === slides.length - 1) {
            rightArrow.style.animation = 'none';
        } else {
            rightArrow.style.animation = 'pulse 2s infinite';
        }
    }

    function goToSlide(index) {
        if (index >= 0 && index < slides.length) {
            currentSlide = index;
            showSlide(currentSlide);
        }
    }

    function nextSlide() {
        if (currentSlide < slides.length - 1) {
            currentSlide++;
            showSlide(currentSlide);
        }
    }

    function prevSlide() {
        if (currentSlide > 0) {
            currentSlide--;
            showSlide(currentSlide);
        }
    }

    if (leftArrow) leftArrow.addEventListener('click', prevSlide);
    if (rightArrow) rightArrow.addEventListener('click', nextSlide);

    // Event listeners para los dots
    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            goToSlide(index);
        });
    });

    // Inicializar estado de las flechas
    showSlide(0);

    // LÃ³gica del botÃ³n de empezar
    const startQuestionsBtn = document.getElementById('start-questions-btn');
    const questionsSlider = document.getElementById('questions-slider');
    const tournamentSliderContainer = document.querySelector('.tournament-slider-container');
    const contextBanner = document.getElementById('context-banner');

    if (startQuestionsBtn) {
        startQuestionsBtn.addEventListener('click', function () {
            // Ocultar el botÃ³n de empezar
            this.style.display = 'none';

            // Mover el banner hacia abajo suavemente
            if (contextBanner) {
                contextBanner.classList.add('slide-down');
            }

            // Mostrar el slider de preguntas con animaciÃ³n
            questionsSlider.style.display = 'block';
            questionsSlider.classList.add('show');

            // Agregar animaciÃ³n de entrada
            setTimeout(() => {
                questionsSlider.classList.add('animate-in');
            }, 50);

            // Remover la clase de animaciÃ³n despuÃ©s de que termine
            setTimeout(() => {
                questionsSlider.classList.remove('animate-in');
            }, 800);
        });
    }

    // LÃ³gica del slider de preguntas
    const questionSlides = document.querySelectorAll('.question-slide');
    const questionLeftArrow = document.getElementById('question-left');
    const questionRightArrow = document.getElementById('question-right');
    let currentQuestion = 0;
    const answeredQuestions = new Set();
    const correctAnswers = new Set(); // Para rastrear respuestas correctas
    const questionAnswers = {
        1: { true: false, false: true },
        2: { true: true, false: false },
        3: { true: true, false: false },
        4: { true: true, false: false },
        5: { true: true, false: false },
        6: { true: false, false: true }
    };

    const feedbackMessages = {
        1: {
            true: "<h3>ğŸ”´ Incorrecto</h3> La posibilidad de obtener un nÃºmero mayor que 5 es que salga el 6, mientras que las posibilidades de obtener un nÃºmero primo son que salga el 2, 3 Ã³ 5. Por lo tanto, su selecciÃ³n no fue correcta.",
            false: "<h3>ğŸŸ¢ Â¡Correcto!</h3> Es falso, porque la posibilidad de obtener un nÃºmero mayor que 5 es que salga el 6, mientras que las posibilidades de obtener un nÃºmero primo son que salga el 2, 3 Ã³ 5."
        },
        2: {
            true: "<h3>ğŸŸ¢ Â¡Correcto!</h3> Â¡Correcto! La posibilidad de que al lanzar el dado se obtenga como resultado el 1 o un nÃºmero mayor es mÃ¡s probable a que se obtenga un nÃºmero impar.",
            false: "<h3>ğŸ”´ Incorrecto</h3> La posibilidad de que al lanzar el dado se obtenga como resultado el 1 o un nÃºmero mayor es mÃ¡s probable a que se obtenga un nÃºmero impar. Por lo tanto, su selecciÃ³n no fue correcta."
        },
        3: {
            true: "<h3>ğŸŸ¢ Â¡Correcto!</h3> Â¡Correcto! Es mÃ¡s probable obtener un nÃºmero igual o mayor al 1 que obtener como resultado el 7, el cual no estÃ¡ en ninguna de las caras del dado.",
            false: "<h3>ğŸ”´ Incorrecto</h3> Es mÃ¡s probable obtener un nÃºmero igual o mayor al 1 que obtener como resultado el 7, el cual no estÃ¡ en ninguna de las caras del dado. Por lo tanto, su selecciÃ³n no fue correcta."
        },
        4: {
            true: "<h3>ğŸŸ¢ Â¡Correcto!</h3> Â¡Muy bien! La probabilidad de obtener un nÃºmero primo es de <span class=\"fraction\"><span>3</span><span class=\"denominator\">6</span></span>, misma que la de obtener un nÃºmero impar.",
            false: "<h3>ğŸ”´ Incorrecto</h3> La probabilidad de obtener un nÃºmero primo es de <span class=\"fraction\"><span>3</span><span class=\"denominator\">6</span></span>, misma que la de obtener un nÃºmero impar. Por lo tanto, su selecciÃ³n no fue correcta."
        },
        5: {
            true: "<h3>ğŸŸ¢ Â¡Correcto!</h3> Â¡Excelente! La probabilidad de obtener un nÃºmero mayor que 5 es que salga un 6, por lo que serÃ­a un evento que puede suceder.",
            false: "<h3>ğŸ”´ Incorrecto</h3> La probabilidad de obtener un nÃºmero mayor que 5 es que salga un 6, por lo que serÃ­a un evento que puede suceder. Por lo tanto, su selecciÃ³n no fue correcta."
        },
        6: {
            true: "<h3>ğŸ”´ Incorrecto</h3> Existe la probabilidad de obtener un nÃºmero primo, ya sea 2, 3 Ã³ 5. Por lo tanto, su selecciÃ³n no fue correcta.",
            false: "<h3>ğŸŸ¢ Â¡Correcto!</h3> Â¡Muy bien hecho! Falso es la opciÃ³n correcta porque sÃ­ existe la probabilidad de obtener un nÃºmero primo, ya sea 2, 3 Ã³ 5."
        }
    };

    function showQuestion(index) {
        questionSlides.forEach(slide => slide.classList.remove('active'));
        questionSlides[index].classList.add('active');

        // Actualizar estado de las flechas
        questionLeftArrow.disabled = index === 0;

        // La flecha derecha se deshabilita si la pregunta actual no estÃ¡ respondida
        // o si es la Ãºltima pregunta
        const canGoNext = index < questionSlides.length - 1 && answeredQuestions.has(index + 1);
        questionRightArrow.disabled = index === questionSlides.length - 1 || !canGoNext;
    }

    function nextQuestion() {
        if (currentQuestion < questionSlides.length - 1 && answeredQuestions.has(currentQuestion + 1)) {
            currentQuestion++;
            showQuestion(currentQuestion);
        }
    }

    function prevQuestion() {
        if (currentQuestion > 0) {
            currentQuestion--;
            showQuestion(currentQuestion);
        }
    }

    // Event listeners para las flechas de preguntas
    if (questionLeftArrow) questionLeftArrow.addEventListener('click', prevQuestion);
    if (questionRightArrow) questionRightArrow.addEventListener('click', nextQuestion);

    // Event listeners para los botones de respuesta
    document.querySelectorAll('.question-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const questionSlide = this.closest('.question-slide');
            const questionNumber = parseInt(questionSlide.dataset.question);
            const isTrue = this.classList.contains('true-btn');
            const isCorrect = this.dataset.correct === 'true';

            // Marcar la pregunta como respondida
            answeredQuestions.add(questionNumber);

            // Rastrear respuestas correctas
            if (isCorrect) {
                correctAnswers.add(questionNumber);
            }

            // Obtener todos los botones de la pregunta
            const allBtns = questionSlide.querySelectorAll('.question-btn');

            // Deshabilitar todos los botones
            allBtns.forEach(b => {
                b.disabled = true;
            });

            // Marcar el botÃ³n seleccionado
            this.classList.add('selected');

            // Encontrar y marcar la respuesta correcta con parpadeo
            const correctBtn = Array.from(allBtns).find(b => b.dataset.correct === 'true');
            if (correctBtn) {
                correctBtn.classList.add('correct-answer');
            }

            // Si la respuesta seleccionada es incorrecta, marcarla como tal
            if (!isCorrect) {
                this.classList.add('incorrect-selected');
            }

            // Aplicar estilos legacy para compatibilidad
            allBtns.forEach(b => {
                if (b === this) {
                    b.classList.add(isCorrect ? 'correct' : 'incorrect');
                    b.classList.add('chosen');
                } else {
                    b.classList.add(isCorrect ? 'incorrect' : 'correct');
                }
            });

            // Mostrar feedback despuÃ©s de un breve delay para que se vean los efectos
            setTimeout(() => {
                const feedbackArea = questionSlide.querySelector('.feedback-area');
                const feedbackMessage = questionSlide.querySelector('.feedback-message');
                const answer = isTrue ? 'true' : 'false';
                feedbackMessage.innerHTML = feedbackMessages[questionNumber][answer];
                feedbackArea.style.display = 'block';

                // Actualizar estado de las flechas despuÃ©s de responder
                showQuestion(currentQuestion);

                // Si es la Ãºltima pregunta (pregunta 6), mostrar el resumen final
                if (questionNumber === 6) {
                    showFinalScore();
                }
            }, 1000);
        });
    });

    // Event listeners para los botones de siguiente pregunta
    document.querySelectorAll('.next-question-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            nextQuestion();
        });
    });

    // FunciÃ³n para mostrar el resumen final de puntuaciÃ³n
    function showFinalScore() {
        const totalQuestions = 6;
        const correctCount = correctAnswers.size;
        const percentage = Math.round((correctCount / totalQuestions) * 100);

        const finalFeedbackArea = document.querySelector('.final-feedback-area');
        const finalFeedbackMessage = document.querySelector('.final-feedback-message');

        let message = '';
        let scoreClass = '';

        if (percentage === 100) {
            message = `Â¡Perfecto! Has acertado <span class="score-highlight">${correctCount} de ${totalQuestions}</span> preguntas (${percentage}%). Â¡Excelente trabajo!`;
            scoreClass = 'perfect';
        } else if (percentage >= 80) {
            message = `Â¡Muy bien! Has acertado <span class="score-highlight">${correctCount} de ${totalQuestions}</span> preguntas (${percentage}%). Â¡Buen trabajo!`;
            scoreClass = 'good';
        } else if (percentage >= 60) {
            message = `Â¡Bien! Has acertado <span class="score-highlight">${correctCount} de ${totalQuestions}</span> preguntas (${percentage}%). Puedes mejorar.`;
            scoreClass = 'average';
        } else {
            message = `Has acertado <span class="score-highlight">${correctCount} de ${totalQuestions}</span> preguntas (${percentage}%). Te recomiendo repasar los conceptos.`;
            scoreClass = 'needs-improvement';
        }

        finalFeedbackMessage.innerHTML = message;
        finalFeedbackArea.style.display = 'block';
    }

    // Event listeners para los botones finales
    document.getElementById('restart-tournament').addEventListener('click', function () {
        // Reiniciar el torneo
        currentQuestion = 0;
        answeredQuestions.clear();
        correctAnswers.clear(); // Limpiar respuestas correctas
        showQuestion(0);

        // Limpiar estados de preguntas
        document.querySelectorAll('.question-slide').forEach(slide => {
            slide.querySelectorAll('.question-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('correct', 'incorrect', 'chosen', 'selected', 'correct-answer', 'incorrect-selected');
            });
            slide.querySelector('.feedback-area').style.display = 'none';
        });

        // Ocultar Ã¡rea de feedback final
        const finalFeedbackArea = document.querySelector('.final-feedback-area');
        if (finalFeedbackArea) {
            finalFeedbackArea.style.display = 'none';
        }

        // Ocultar slider de preguntas y mostrar botÃ³n de empezar
        questionsSlider.classList.remove('show');
        questionsSlider.style.display = 'none';

        // Mostrar el botÃ³n de empezar nuevamente
        startQuestionsBtn.style.display = 'block';
    });

    document.getElementById('go-to-three-cups').addEventListener('click', function () {
        // Redirigir al juego de tres vasos
        window.location.href = 'juego-tres-vasos.html';
    });

    // Inicializar estado de las flechas de preguntas
    showQuestion(0);

    // Modal de materiales torneo
    function initMaterialsModalTournament() {
        const modal = document.getElementById('materials-modal-tournament');
        const btn = document.getElementById('materials-btn-tournament');
        const closeBtn = modal.querySelector('.modal-close');

        btn.addEventListener('click', () => {
            modal.classList.add('show');
            setTimeout(() => {
                modal.classList.add('animate-in');
            }, 10);
        });

        closeBtn.addEventListener('click', () => {
            modal.classList.remove('animate-in');
            setTimeout(() => {
                modal.classList.remove('show');
            }, 300);
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('animate-in');
                setTimeout(() => {
                    modal.classList.remove('show');
                }, 300);
            }
        });
    }

    if (document.getElementById('materials-modal-tournament')) {
        initMaterialsModalTournament();
    }

    // BotÃ³n de instrucciones para reabrir el modal de bienvenida
    const instructionsBtn = document.getElementById('instructions-btn-tournament');
    if (instructionsBtn) {
        instructionsBtn.addEventListener('click', () => {
            welcomeModal.style.display = 'flex';
            welcomeModal.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            const dialog = welcomeModal.querySelector('.modal-dialog');
            if (dialog) {
                dialog.style.transform = 'scale(0.7) translateY(-50px)';
                dialog.style.opacity = '0';
            }

            // AnimaciÃ³n suave de entrada
            setTimeout(() => {
                welcomeModal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                if (dialog) {
                    dialog.style.transform = 'scale(1) translateY(0)';
                    dialog.style.opacity = '1';
                }
            }, 10);
        });
    }
}); 